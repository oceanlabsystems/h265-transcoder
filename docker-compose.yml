# H265 Transcoder Docker Compose
# Quick start: docker-compose up -d
#
# Hardware Encoding (Intel VA-API):
#   1. Uncomment the 'devices' section below
#   2. Set encoder: vaapih265 in config/config.yaml
#   3. Verify with: docker exec h265-transcoder vainfo
#
# Hardware Encoding (NVIDIA NVENC):
#   1. Uncomment the 'deploy.reservations.devices' section below
#   2. Set encoder: nvh265 in config/config.yaml
#   3. Requires NVIDIA Container Toolkit on host

version: '3.8'

services:
  h265-transcoder:
    build: .
    # Or use pre-built image:
    # image: oceanlabsystems/h265-transcoder:latest
    container_name: h265-transcoder
    restart: unless-stopped
    
    # Uncomment for Intel VA-API hardware encoding
    # devices:
    #   - /dev/dri:/dev/dri
    
    # Uncomment for NVIDIA NVENC hardware encoding
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    
    volumes:
      # Mount your video directories
      - ./input:/input:ro          # Source videos (read-only)
      - ./output:/output           # Transcoded output
      - ./config:/config           # Configuration file
      # Optional: move processed files
      # - ./processed:/processed
      # - ./failed:/failed
    environment:
      - NODE_ENV=production
    # Override default command if needed:
    # command: ["--input", "/input", "--output", "/output", "--watch", "--encoder", "x265"]
